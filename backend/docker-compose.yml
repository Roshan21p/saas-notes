# Docker Compose configuration for SaaS Notes application
# Defines two services:
#   - backend: Node.js/Express API server running on port 8080
#   - mongo: MongoDB database with health checks and data persistence
# Uses a bridge network to allow container communication

version: "3.9"

services:
  backend:
    build: .
    container_name: saas-backend

    # Expose backend to host
    ports:
      - "8080:8080"

    # Load environment variables
    env_file:
      - .env

    # Backend starts ONLY after Mongo is healthy
    depends_on:
      mongo:
        condition: service_healthy

    # Restart backend if it crashes
    restart: always
    networks:
      - saas-network

  mongo:
    image: mongo:7
    container_name: saas-mongo

    # Mongo data persistence
    volumes:
      - mongo_data:/data/db

    # Restart Mongo automatically
    restart: always

    # Healthcheck to confirm Mongo is ready
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - saas-network

# Named volume for MongoDB data
volumes:
  mongo_data:

# Custom bridge network for inter-container communication
networks:
  saas-network:
    driver: bridge
