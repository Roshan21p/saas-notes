# Docker Compose configuration for SaaS Notes application
# Defines three services:
#   - backend: Node.js/Express API server running on port 8080
#   - mongo: MongoDB database with data persistence and health checks
#   - frontend: React frontend served via nginx on port 80 inside container (mapped to 5173 on host)
# Uses a custom bridge network to allow seamless communication between containers

version: "3.9"

services:
  backend:
    build: ./backend
    container_name: saas-backend

    # Expose backend API on host port 8080
    ports:
      - "8080:8080"

    # Load environment variables from backend folder
    env_file:
      - ./backend/.env

    # Backend service waits for MongoDB to be healthy before starting
    depends_on:
      mongo:
        condition: service_healthy

    # Restart backend automatically if it crashes or stops unexpectedly
    restart: always

    # Connect backend to the custom bridge network for inter-container communication
    networks:
      - saas-network

  mongo:
    image: mongo:7
    container_name: saas-mongo

    # Persist MongoDB data in named volume 'mongo_data' so data is not lost on container restart
    volumes:
      - mongo_data:/data/db

    # Restart MongoDB automatically on failure or system reboot
    restart: always

    # Healthcheck to verify MongoDB is running and ready before dependent containers start
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
      interval: 30s
      timeout: 10s
      retries: 3

    # Connect MongoDB to the same custom network
    networks:
      - saas-network

  frontend:
    build: ./frontend
    container_name: saas-frontend

    # Map host port 5173 to container port 80 where nginx serves the frontend app
    ports:
      - "5173:80"

    # Set environment variable for frontend to call backend API via localhost (adjust as needed)
    environment:
      - VITE_BACKEND_API_URL=http://localhost:8080/api/v1

    # Ensure frontend starts only after backend is up
    depends_on:
      - backend

    # Connect frontend to the shared network
    networks:
      - saas-network

# Named volume to persist MongoDB data between container restarts
volumes:
  mongo_data:

# Custom bridge network to allow containers to communicate by service name
networks:
  saas-network:
    driver: bridge
